#
# Installation
#

- name: Directory for git repository
  file:
    path="{{ tendrl_dashboard_repo }}"
    state=directory

- name: Clone git repository
  git:
    repo={{ tendrl_dashboard_repo_url }}
    version={{ tendrl_dashboard_repo_branch }}
    dest={{ tendrl_dashboard_repo }}

- name: Install gulp
  npm:
    name=gulp
    global=yes
    path={{ tendrl_dashboard_repo }}

- name: Install tendrl_dashboard gulp packages
  npm:
    path={{ tendrl_dashboard_repo }}

# As documented in Issue: https://github.com/Tendrl/dashboard/issues/78
- name: Install fontconfig dependency for gulp
  yum:
    name={{ item }}
    state=present
  with_items:
    - fontconfig
  register: task_result
  until: task_result|success
  retries: 5
  delay: 5
    
- name: Run gulp compile command
  command: gulp
    chdir={{ tendrl_dashboard_repo }}

# As documented in documentation: https://github.com/Tendrl/dashboard/blob/master/docs/deployment.adoc
# Directory /var/www/tendrl/ is used because same directory is used by installation from packages
- name: Copy web files generated by gulp
  command: "cp -r {{ tendrl_dashboard_repo }}/dist/ /var/www/tendrl/"
